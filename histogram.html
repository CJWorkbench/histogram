<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <title>Histogram output</title>
    <style>
      html, body {
        box-sizing: border-box;
        padding: 0;
        margin: 0;
        height: 100vh;
        overflow: hidden;
        background: white;
      }

      main {
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        overflow: hidden;
      }

      #vega {
        padding-right: 0; /* override vega-embed.css */
      }

      #vega details {
        /* override vega-embed.css */
        /* place dropdown to *not* exceed <body>. */
        position: absolute;
        right: 9px; /* [2020-12-15, vega-embed@6] .vega-actions has right: -9px */
        top: 0;
      }
    </style>
  </head>
  <body>
    <main></main>
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
    <script>
      const main = document.querySelector('main')
      let vegaViewPromise = Promise.resolve(null)

      const loadingSpec = {
        "title": "loading",
        "mark": "point",
        "config": {
          "style": {
            "cell": {
              "stroke": "transparent"
            }
          }
        }
      }

      const emptySpec = {
        "title": "no data",
        "mark": "point",
        "config": {
          "style": {
            "cell": {
              "stroke": "transparent"
            }
          }
        }
      }

      function renderData(spec) {
        if (!spec) {
          spec = emptySpec
        }

        vegaViewPromise = vegaEmbed(main, spec, {
          config: {
            autosize: {
              type: 'fit',
              contains: 'padding'
            },
            style: {
              cell: {
                stroke: 'transparent',
              }
            },
          }
        })
        resetSize()
      }

      function startLoading () {
        renderData(loadingSpec)

        const url = String(window.location).replace(/\/output.*/, '/embeddata')
        fetch(url, { credentials: 'same-origin' })
          .then(function(response) {
            if (!response.ok) {
              throw new Error('Invalid response code: ' + response.status)
            }

            return response.json()
          })
          .then(renderData)
          .catch(console.error)
      }

      function resetSize() {
        vegaViewPromise.then(function (view) {
          if (view === null) return // init
          const width = document.body.clientWidth
          const height = document.body.clientHeight
          view.view
            .width(width)
            .height(height)
            .run()
        })
      }

      window.addEventListener('hashchange', startLoading)
      window.addEventListener('resize', resetSize)

      startLoading()
    </script>
  </body>
</html>
