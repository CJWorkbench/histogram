<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <title>Histogram output</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vega-embed@3/vega-embed.css">
  </head>
  <body>
    <main></main>
    <script src="https://cdn.jsdelivr.net/npm/vega@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@3"></script>
    <script>
      const main = document.querySelector('main')

      function renderData(spec) {
        if (!spec) {
          main.textContent = 'No data'
          return
        }

        spec = Object.assign({
            "$schema": "https://vega.github.io/schema/vega-lite/v2.0.json",
            "autosize": "fit",
        }, spec)

        vegaEmbed(main, spec)
      }

      function startLoading () {
        main.textContent = 'Loading'

        const url = String(window.location).replace(/\/output.*/, '/embeddata')
          fetch(url, { credentials: 'same-origin' })
          .then(function(response) {
            if (!response.ok) {
              throw new Error('Invalid response code: ' + response.status)
            }

            return response.json()
          })
          .then(renderData)
          .catch(console.error)
      }

      window.addEventListener('hashchange', startLoading)

      vegaEmbed(main, window.workbench.embeddata)
    </script>
  </body>
</html>
