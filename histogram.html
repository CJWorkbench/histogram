<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <title>Histogram output</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vega-embed@3/vega-embed.css">
    <style>
      html, body, main {
        box-sizing: border-box;
        padding: 0;
        margin: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: white;
        border-bottom: 0.05rem solid #f4f4f4;
      }

      html {
        padding: 1rem;
      }
    </style>
  </head>
  <body>
    <main></main>
    <script src="https://cdn.jsdelivr.net/npm/vega@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@3.23.1"></script>
    <script>
      const main = document.querySelector('main')
      let vegaViewPromise = Promise.resolve(null)

      const loadingSpec = {
        "title": "loading",
        "mark": "point",
        "config": {
          "style": {
            "cell": {
              "stroke": "transparent"
            }
          }
        }
      }

      const emptySpec = {
        "title": "no data",
        "mark": "point",
        "config": {
          "style": {
            "cell": {
              "stroke": "transparent"
            }
          }
        }
      }

      function renderData(spec) {
        if (!spec) {
          spec = emptySpec
        }

        vegaViewPromise = vegaEmbed(main, spec, {
          config: {
            autosize: {
              type: 'fit',
              contains: 'padding'
            },
            style: {
              cell: {
                stroke: 'transparent',
              }
            },
          }
        })
        resetSize()
      }

      function startLoading () {
        renderData(loadingSpec)

        const url = String(window.location).replace(/\/output.*/, '/embeddata')
        fetch(url, { credentials: 'same-origin' })
          .then(function(response) {
            if (!response.ok) {
              throw new Error('Invalid response code: ' + response.status)
            }

            return response.json()
          })
          .then(renderData)
          .catch(console.error)
      }

      function resetSize() {
        vegaViewPromise.then(function (view) {
          if (view === null) return // init
          const width = document.body.clientWidth
          const height = document.body.clientHeight
          view.view
            .width(width)
            .height(height)
            .run()
        })
      }

      window.addEventListener('hashchange', startLoading)
      window.addEventListener('resize', resetSize)

      startLoading()
    </script>
  </body>
</html>
